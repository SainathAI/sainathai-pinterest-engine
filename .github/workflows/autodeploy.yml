name: Autopush to HuggingFace Space

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  push-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure git user
        run: |
          git config --global user.email "bot@sainathai.com"
          git config --global user.name "SainathAI Bot"

      - name: Add HF remote and push
        env:
          HF_ACCESS_TOKEN: ${{ secrets.HF_ACCESS_TOKEN }}
          HF_SPACE_OWNER: ${{ secrets.HF_SPACE_OWNER }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          if [ -z "${HF_ACCESS_TOKEN}" ] || [ -z "${HF_SPACE_OWNER}" ] || [ -z "${HF_SPACE_NAME}" ]; then
            echo "Missing one of HF_ACCESS_TOKEN / HF_SPACE_OWNER / HF_SPACE_NAME. Aborting."
            exit 1
          fi
          set -eux
          HF_REMOTE_URL="https://${HF_SPACE_OWNER}:${HF_ACCESS_TOKEN}@huggingface.co/spaces/${HF_SPACE_OWNER}/${HF_SPACE_NAME}.git"
          # add remote only if not present
          if git remote | grep -q "^hf$"; then
            git remote remove hf || true
          fi
          git remote add hf "${HF_REMOTE_URL}"
          git push hf HEAD:main --force

      - name: Trigger HF rebuild
        env:
          HF_ACCESS_TOKEN: ${{ secrets.HF_ACCESS_TOKEN }}
          HF_SPACE_OWNER: ${{ secrets.HF_SPACE_OWNER }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          if [ -z "${HF_ACCESS_TOKEN}" ]; then
            echo "HF token missing; cannot trigger build"
            exit 0
          fi
          curl -s -X POST \
            -H "Authorization: Bearer ${HF_ACCESS_TOKEN}" \
            "https://huggingface.co/api/spaces/${HF_SPACE_OWNER}/${HF_SPACE_NAME}/build" \
            -o /tmp/hf_build_response.json || true
          echo "HF build response:"
          sed -n '1,200p' /tmp/hf_build_response.json || true
