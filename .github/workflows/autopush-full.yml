name: Full Autopush Rebuild (Structure A)

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  autopush:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      GH_PAT: ${{ secrets.GH_PAT_ACCESS }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Configure Git for pushes
        run: |
          git config user.name "sainathai-autobot"
          git config user.email "autobot@sainathai.local"
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${REPO}.git

      - name: Create folder structure
        run: |
          mkdir -p server playwright engine pinterest ollama/prompts n8n/workflows

      - name: Write Dockerfile (HF-compatible)
        run: |
          cat > Dockerfile <<'DOCKER_EOF'
FROM mcr.microsoft.com/playwright:v1.43.0-jammy

WORKDIR /app

COPY package.json package.json
COPY playwright/package.json playwright/package.json

RUN npm install --production || true
RUN cd playwright && npm install --production || true

COPY . /app

EXPOSE 7860
EXPOSE 3000

CMD ["node", "server/index.js"]
DOCKER_EOF

      - name: Write root package.json
        run: |
          cat > package.json <<'PKG_EOF'
{
  "name": "sainathai-engine",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "start": "node server/index.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "axios": "^1.6.0"
  }
}
PKG_EOF

      - name: Write server files
        run: |
          cat > server/index.js <<'SRV_EOF'
const express = require("express");
const cors = require("cors");
const pinterest = require("./pinterest");

const app = express();
app.use(cors());
app.use(express.json());

app.get("/healthz", (req, res) => res.send("OK"));
app.get("/", (req, res) => res.send("SainathAI Pinterest Engine - OK"));

app.post("/post-pin", pinterest.postPin);

const port = process.env.PORT || 3000;
app.listen(port, () => console.log("Server running on", port));
SRV_EOF

          cat > server/pinterest.js <<'PIN_EOF'
const axios = require("axios");

exports.postPin = async (req, res) => {
  try {
    const token = process.env.PINTEREST_ACCESS_TOKEN;
    if (!token) return res.status(500).json({ success: false, error: "Missing PINTEREST_ACCESS_TOKEN" });
    const payload = req.body;
    const r = await axios.post("https://api.pinterest.com/v5/pins", payload, {
      headers: { Authorization: `Bearer ${token}` }
    });
    res.json({ success: true, data: r.data });
  } catch (err) {
    res.status(500).json({ success: false, error: err.response?.data || err.message });
  }
};
PIN_EOF

      - name: Write playwright package.json
        run: |
          cat > playwright/package.json <<'PWPKG_EOF'
{
  "name": "playwright-renderer",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "start": "node render_canva.js"
  },
  "dependencies": {
    "axios": "^1.6.0",
    "playwright": "^1.43.0"
  }
}
PWPKG_EOF

      - name: Write render_canva.js placeholder
        run: |
          cat > playwright/render_canva.js <<'REND_EOF'
module.exports = async function(params) {
  // placeholder renderer function â€” real renderer will be added next
  return { ok: true, params };
};
REND_EOF

      - name: Write engine and helper files
        run: |
          cat > engine/niche-rotation.js <<'NICH_EOF'
module.exports = ["Mindset & Motivation","Business & Entrepreneurship","AI Tools & Automation","Health & Fitness Tips"];
NICH_EOF

          cat > engine/content-engine.js <<'CONT_EOF'
module.exports = async function(niche) {
  return {
    title: `Top ${niche} Hacks`,
    description: `Automated ${niche} content generated by SainathAI.`
  };
};
CONT_EOF

      - name: Create .dockerignore and AUDIT.md
        run: |
          cat > .dockerignore <<'DCK_EOF'
node_modules
.git
.gitignore
.vscode
*.log
DCK_EOF

          echo "# AUTOPUSH AUDIT - $(date)" > AUDIT.md
          echo "Autopush created/repaired core files and structure." >> AUDIT.md

      - name: Commit & push changes
        run: |
          git add Dockerfile package.json playwright/package.json server server/pinterest.js engine .dockerignore AUDIT.md || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "AUTOPUSH: full repo rebuild (Structure A)"
            git push origin HEAD:main
          fi
