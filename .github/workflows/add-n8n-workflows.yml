name: Add n8n Workflows (Create PR)
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  add-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git
        run: |
          git config user.name "sainathai-bot"
          git config user.email "noreply@sainathai.local"

      - name: Create n8n workflows files
        run: |
          set -e
          mkdir -p n8n/workflows

          # rotation-scheduler.json
          cat > n8n/workflows/rotation-scheduler.json <<'EOF'
{
  "name": "rotation-scheduler",
  "nodes": [
    {
      "parameters": {
        "mode": "on",
        "cronExpression": "0 3 * * *"
      },
      "id": "cron-1",
      "name": "Daily Cron",
      "type": "n8n-nodes-base.cron"
    },
    {
      "parameters": {},
      "id": "function-1",
      "name": "Decide Niche",
      "type": "n8n-nodes-base.function"
    },
    {
      "parameters": {
        "path": "content-generator"
      },
      "id": "webhook-1",
      "name": "Trigger Content Generator",
      "type": "n8n-nodes-base.webhook"
    }
  ],
  "connections": {}
}
EOF

          # content-generator.json
          cat > n8n/workflows/content-generator.json <<'EOF'
{
  "name": "content-generator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "content-generator"
      },
      "id": "webhook-cg",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "http://{{OLLAMA_HOST}}/api/generate"
      },
      "id": "http-ollama",
      "name": "Call Ollama (LLM)",
      "type": "n8n-nodes-base.httpRequest"
    },
    {
      "parameters": {},
      "id": "sheets-append",
      "name": "Append to Google Sheets",
      "type": "n8n-nodes-base.googleSheets"
    }
  ],
  "connections": {}
}
EOF

          # canva-builder.json
          cat > n8n/workflows/canva-builder.json <<'EOF'
{
  "name": "canva-builder",
  "nodes": [
    {
      "parameters": {
        "operation": "read"
      },
      "id": "sheets-read",
      "name": "Read Pending Rows",
      "type": "n8n-nodes-base.googleSheets"
    },
    {
      "parameters": {},
      "id": "function-buildcsv",
      "name": "Build CSV for Canva",
      "type": "n8n-nodes-base.function"
    },
    {
      "parameters": {
        "url": "http://playwright-renderer/render"
      },
      "id": "http-playwright",
      "name": "Trigger Playwright Renderer",
      "type": "n8n-nodes-base.httpRequest"
    }
  ],
  "connections": {}
}
EOF

          # export-monitor.json
          cat > n8n/workflows/export-monitor.json <<'EOF'
{
  "name": "export-monitor",
  "nodes": [
    {
      "parameters": {
        "path": "playwright/output"
      },
      "id": "fs-watch",
      "name": "Watch Output",
      "type": "n8n-nodes-base.watch"
    },
    {
      "parameters": {},
      "id": "drive-upload",
      "name": "Upload to Google Drive",
      "type": "n8n-nodes-base.googleDrive"
    },
    {
      "parameters": {},
      "id": "sheets-update",
      "name": "Mark Ready in Sheets",
      "type": "n8n-nodes-base.googleSheets"
    }
  ],
  "connections": {}
}
EOF

          # pinterest-poster.json
          cat > n8n/workflows/pinterest-poster.json <<'EOF'
{
  "name": "pinterest-poster",
  "nodes": [
    {
      "parameters": {
        "operation": "read"
      },
      "id": "sheets-get-ready",
      "name": "Get Ready Pins",
      "type": "n8n-nodes-base.googleSheets"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.pinterest.com/v5/pins"
      },
      "id": "http-pinterest",
      "name": "Post to Pinterest",
      "type": "n8n-nodes-base.httpRequest"
    },
    {
      "parameters": {},
      "id": "sheets-mark-posted",
      "name": "Mark Posted",
      "type": "n8n-nodes-base.googleSheets"
    }
  ],
  "connections": {}
}
EOF

          # analytics-engine.json
          cat > n8n/workflows/analytics-engine.json <<'EOF'
{
  "name": "analytics-engine",
  "nodes": [
    {
      "parameters": {
        "cronExpression": "0 4 * * 0"
      },
      "id": "cron-analytics",
      "name": "Weekly Cron",
      "type": "n8n-nodes-base.cron"
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "https://api.pinterest.com/v5/analytics/boards"
      },
      "id": "http-analytics",
      "name": "Pull Pinterest Analytics",
      "type": "n8n-nodes-base.httpRequest"
    },
    {
      "parameters": {},
      "id": "sheets-write-analytics",
      "name": "Write Analytics to Sheets",
      "type": "n8n-nodes-base.googleSheets"
    }
  ],
  "connections": {}
}
EOF

          echo "n8n workflow files created"
        shell: bash

      - name: Create Pull Request (auto)
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: add n8n workflow JSONs (rotation, content, canva, export, poster, analytics)"
          branch: add-n8n-workflows-${{ github.run_id }}
          title: "Add n8n workflows (rotation, generator, canva, export, poster, analytics)"
          body: |
            This PR adds the initial n8n workflow JSONs for the Pinterest automation engine:
            - rotation-scheduler.json
            - content-generator.json
            - canva-builder.json
            - export-monitor.json
            - pinterest-poster.json
            - analytics-engine.json

            After merging:
            1. Import workflows into n8n (or place files under n8n/workflows/).
            2. Set credentials: GOOGLE_SERVICE_ACCOUNT, PINTEREST_TOKEN, OLLAMA_HOST, PLAYWRIGHT_RENDERER_URL.
            3. Run a dry-run with small batches.
          base: main
