name: autopush-full

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  autopush:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git for pushes
        run: |
          git config user.name "autopush-bot"
          git config user.email "autopush-bot@sainath.ai"
          # set remote using PAT from secrets (GH_PAT_ACCESS)
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT_ACCESS }}@github.com/${{ env.REPO }}.git

      - name: Create folder structure
        run: |
          mkdir -p server playwright engine/pinterest ollama/prompts n8n/workflows

      - name: Write Dockerfile
        run: |
          cat > Dockerfile <<'DOCKER_EOF'
FROM mcr.microsoft.com/playwright:v1.43.0-jammy
WORKDIR /app

# Copy root package metadata and install production deps
COPY package.json package-lock.json* ./
RUN npm ci --omit=dev || npm install --production || true

# Copy full repo contents
COPY . .

EXPOSE 3000
EXPOSE 7860

CMD ["node", "server/index.js"]
DOCKER_EOF

      - name: Write root package.json
        run: |
          cat > package.json <<'PKG_EOF'
{
  "name": "sainathai-engine",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "start": "node server/index.js",
    "start:dev": "NODE_ENV=development node server/index.js"
  },
  "dependencies": {
    "express": "^4.18.2"
  }
}
PKG_EOF

      - name: Write playwright package.json
        run: |
          mkdir -p playwright
          cat > playwright/package.json <<'PWKG_EOF'
{
  "name": "sainathai-playwright",
  "version": "0.1.0",
  "private": true,
  "dependencies": {
    "playwright": "1.43.0"
  },
  "scripts": {
    "test": "echo \"no tests\""
  }
}
PWKG_EOF

      - name: Write server index.js (health endpoint)
        run: |
          mkdir -p server
          cat > server/index.js <<'SRV_EOF'
const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

app.get('/healthz', (req, res) => res.send('OK'));
app.get('/', (req, res) => res.send('SainathAI Pinterest Engine — OK'));

app.listen(PORT, () => {
  console.log(`Server listening on ${PORT}`);
});
SRV_EOF

      - name: Stage and commit changes
        run: |
          git add -A
          git commit -m "chore: autopush — write Dockerfile, package.json, server/index.js" || echo "No changes to commit"

      - name: Push to main
        run: |
          git push origin HEAD:main
