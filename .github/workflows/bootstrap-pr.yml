name: Bootstrap SainathAI Pinterest Engine (Create PR)
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
      
jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.name "sainathai-bot"
          git config user.email "noreply@sainathai.local"

      - name: Create repo skeleton files
        run: |
          set -e
          mkdir -p n8n/workflows playwright/templates ollama/prompts pinterest/api google utils

          cat > README.md <<'README'
# sainathai-pinterest-engine (Bootstrap)

This repository was initialized by the SainathAI Bootstrap Action.
It contains starter artifacts for the Pinterest Automation Engine.
README

          cat > .gitignore <<'GITIGNORE'
n8n/data/
.env
node_modules/
*.zip
playwright/output/
google/credentials.json
GITIGNORE

          cat > docker-compose.yml <<'DC'
version: "3.8"

services:
  n8n:
    image: n8nio/n8n
    container_name: sainathai_n8n
    ports:
      - "5678:5678"
    volumes:
      - ./n8n/data:/home/node/.n8n
      - ./n8n/workflows:/workflows
    environment:
      - TZ=Asia/Kolkata
      - N8N_LOG_OUTPUT=console
      - N8N_ENCRYPTION_KEY=replace_with_secure_key
    restart: always

  playwright:
    build: ./playwright
    container_name: sainathai_playwright
    volumes:
      - ./playwright:/app
      - ./playwright/output:/output
    environment:
      - NODE_ENV=production
    restart: always

  ollama:
    image: ollama/ollama
    container_name: sainathai_ollama
    ports:
      - "11434:11434"
    volumes:
      - ./ollama:/root/.ollama
    restart: always
DC

          cat > .env.example <<'ENV'
# n8n
N8N_HOST=localhost
N8N_PORT=5678
N8N_PROTOCOL=http
N8N_ENCRYPTION_KEY=replace_with_secure_key

# Google
GOOGLE_SA_KEY_PATH=google/credentials.json

# Pinterest
PINTEREST_ACCESS_TOKEN=

# Ollama (if used locally)
OLLAMA_HOST=http://localhost:11434
ENV

          cat > n8n/workflows/rotation-scheduler.json <<'WF'
{
  "name": "rotation-scheduler",
  "nodes": [],
  "connections": {}
}
WF

          cat > playwright/Dockerfile <<'DF'
FROM node:18-slim
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci --production || true
COPY . .
CMD ["node", "render_canva.js"]
DF

          cat > playwright/render_canva.js <<'JS'
/**
 * render_canva.js
 * Placeholder Playwright script to automate Canva bulk create.
 */
(async () => {
  console.log("Playwright renderer placeholder - implement automation here.");
})();
JS

          cat > ollama/prompts/ai-tools.txt <<'P'
# Ollama prompt: AI Tools
Generate Pinterest pin titles for AI Tools niche.
P

          cat > ollama/prompts/productivity.txt <<'P'
# Ollama prompt: Productivity
Generate Pinterest pin titles for Productivity niche.
P

          cat > ollama/prompts/digital-marketing.txt <<'P'
# Ollama prompt: Digital Marketing
Generate Pinterest pin titles for Digital Marketing micro-niches.
P

          cat > ollama/prompts/mmo.txt <<'P'
# Ollama prompt: Make Money Online (MMO)
Generate Pinterest pin titles for Make Money Online (AI workflows).
P

          cat > pinterest/api/post-pin.js <<'NODE'
/**
 * post-pin.js
 * Pinterest posting scaffold - for use inside n8n or as a microservice.
 */
console.log("Pinterest API scaffold - add posting logic or use within n8n HTTP Request nodes.");
NODE

          cat > google/sheets.js <<'JS'
/**
 * sheets.js
 * Placeholder - Google Sheets helper to read/write rows.
 */
module.exports = {};
JS

          cat > utils/logger.js <<'LOG'
module.exports = {
  info: (...args) => console.log("[INFO]", ...args),
  err: (...args) => console.error("[ERROR]", ...args)
};
LOG

          cat > LICENSE <<'LIC'
MIT License
Copyright (c) 2025 Sainath
LIC

          git status --porcelain
        shell: bash

      - name: Commit and push branch
        run: |
          set -e
          BRANCH="sainathai-bootstrap-$(date +%s)"
          git checkout -b "$BRANCH"
          git add .
          git commit -m "chore: bootstrap repo skeleton (sainathai-pinterest-engine)" || true
          git push -u origin "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
        shell: bash

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls"
          PR_TITLE="Bootstrap: repo skeleton (SainathAI Pinterest Engine)"
          PR_BODY="This PR was created automatically by the bootstrap workflow. It includes starter files for the Pinterest automation engine (n8n workflows, Playwright scaffold, Ollama prompts, docker-compose, etc.)."
          echo "Creating PR from branch: $BRANCH"
          curl -s -X POST -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -d "{\"title\":\"${PR_TITLE}\",\"head\":\"${BRANCH}\",\"base\":\"main\",\"body\":\"${PR_BODY}\"}" \
            $API_URL > /tmp/pr_response.json || true
          echo "PR response:"
          cat /tmp/pr_response.json || true
